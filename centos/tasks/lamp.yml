# Ansible Playbook 
# Erik van Oudheusden erik.vanoudheusden@va.gov - 21 Sep 2017
#
# Install Lamp

---
- name: lamp.yml - Install the packages
  yum:
    name:
      - httpd
      - mariadb-server
      - mariadb
      - php
      #- php-mysql
      - mod_ssl
      - openssl
      - phpmyadmin
  
- name: lamp.yml - Set firewall rule to allow http  
  firewalld:
    zone: public
    service: http
    permanent: true
    state: enabled
  
- name: lamp.yml - Set firewall rule to allow https  
  firewalld:
    zone: public
    service: https
    permanent: true
    state: enabled
  
- name: lamp.yml - Set firewall rule to allow http  
  firewalld:
    zone: public
    service: http
    permanent: true
    state: enabled
  
- name: lamp.yml - Reload Firewall
  service: name=firewalld state=restarted

- name: lamp.yml - Web service enabled and running
  service:
    name: httpd
    enabled: true
    state: started
 
- name: lamp.yml - MariaDB enabled and running
  service:
    name: mariadb
    enabled: true
    state: started
  
- name: lamp.yml - edit test.php
  blockinfile: 
    path: /var/www/html/test.php
    create: yes
    backup: yes
    marker: "{mark} KJETT Test Page!"
    owner: apache
    group: apache
    mode: 0644
    content: |
      <?php phpinfo(); ?>
  
- name: lamp.yml - Configure phpMyAdmin for remote access (require) bottom
  lineinfile:
    path: /etc/httpd/conf.d/phpMyAdmin.conf
    backup: yes
    backrefs: yes
    regexp: '^       Require ip 127.0.0.1'
    line: '       Require ip 172.16.4.0/24'
  
- name: lamp.yml - Configure phpMyAdmin for remote access (allow) bottom
  lineinfile:
    path: /etc/httpd/conf.d/phpMyAdmin.conf
    backrefs: yes
    regexp: '^     Allow from 127.0.0.1'
    line: '     Allow from 172.16.4.0/24'
  
- name: lamp.yml - Configure phpMyAdmin for remote access (require) top
  lineinfile:
    path: /etc/httpd/conf.d/phpMyAdmin.conf
    backrefs: yes
    regexp: '^       Require ip 127.0.0.1'
    line: '       Require ip 172.16.4.0/24'
  
- name: lamp.yml - Configure phpMyAdmin for remote access (allow) top
  lineinfile:
    path: /etc/httpd/conf.d/phpMyAdmin.conf
    backrefs: yes
    regexp: '^     Allow from 127.0.0.1'
    line: '     Allow from 172.16.4.0/24'
  
- name: lamp.yml - Restart http
  service:
      name: httpd
      state: restarted
  
- name: lamp.yml - Restart MariaDB
  service:
      name: mariadb
      state: restarted
